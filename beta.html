<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>D2 Armor Analyzer - By ErebusAres</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="beta.css" />

</head>
<body data-theme="eclipse">
  <div class="wrap">
    <header class="panel panel-header">
      <div class="panel-header__layout">
        <div class="panel-header__content">
          <h1>D2 Armor Analyzer</h1>
          <div class="muted">♦ Upload your DIM CSV; dupes use top‑3 stat identities within ± tolerance. Exotics compare only against same‑name items.</div>
          <div class="muted">♦ Click "Restore last" to reload the last uploaded CSV from this browser.</div>
          <div class="muted">♦ Click "Copy ID" or A Group Badge to copy to clipboard.</div>
          <div class="theme-toggle-wrap">
            <span class="theme-toggle__legend">Display Theme</span>
            <div class="theme-toggle" id="themeToggle" role="group" aria-label="Select display theme"></div>
          </div>
        </div>
        <div class="toolbar">
          <input id="file" type="file" accept=".csv" class="toolbar__input" />
          <label id="uploadTrigger" class="tool-card tool-card--upload" for="file" role="button" tabindex="0">
            <span class="tool-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 4v9" />
                <path d="M9 7l3-3 3 3" />
                <path d="M5 14v6h14v-6" />
              </svg>
            </span>
            <span class="tool-copy">
              <span class="tool-title">Upload CSV</span>
              <span class="tool-sub" id="uploadHint" data-default="Choose DIM Armor.csv" aria-live="polite">Choose DIM Armor.csv</span>
            </span>
          </label>
          <button class="tool-card tool-card--restore" id="restoreBtn" type="button" aria-label="Restore last uploaded CSV">
            <span class="tool-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 6v6h-6" />
                <path d="M20 12a8 8 0 1 1-8-8" />
              </svg>
            </span>
            <span class="tool-copy">
              <span class="tool-title">Restore last</span>
              <span class="tool-sub">Load recent upload</span>
            </span>
          </button>
          <button class="tool-card tool-card--clear" id="clearBtn" type="button" aria-label="Clear all data">
            <span class="tool-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 6h16" />
                <path d="M10 6l1-2h2l1 2" />
                <path d="M7 6l1 14h8l1-14" />
                <path d="M10 11v6" />
                <path d="M14 11v6" />
              </svg>
            </span>
            <span class="tool-copy">
              <span class="tool-title">Clear</span>
              <span class="tool-sub">Remove results</span>
            </span>
          </button>
          <button class="tool-card tool-card--signin" id="signInWithBungie" type="button" aria-label="Sign in with Bungie">
            <span class="tool-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 4h16v16H4z" />
                <path d="M4 9h16" />
                <path d="M9 4v16" />
              </svg>
            </span>
            <span class="tool-copy">
              <span class="tool-title">Sign in with Bungie</span>
              <span class="tool-sub">Load live profile</span>
            </span>
          </button>
          <div id="app" class="app-status" aria-live="polite"></div>
        </div>
      </div>
    </header>

    <section class="panel" style="margin-bottom:16px">
      <div class="filters">
        <div class="line"><span class="label">Class</span><div id="classSeg" class="seg"></div></div>
        <div class="line"><span class="label">Rarity</span><div id="raritySeg" class="seg"></div></div>
        <div class="line"><span class="label">Slot</span><div id="slotSeg" class="seg"></div></div>
        <div class="line"><span class="label">Dupes</span><div id="dupesSeg" class="seg"></div></div>
        <div class="line"><span class="label">Tolerance</span><input id="tol" type="number" min="0" max="20" value="5" style="width:80px"/> <span class="muted">± top‑3 stat</span></div>
        <div class="line"><span class="label">Stats</span><div id="statToggle" class="seg"></div></div>
      </div>
    </section>

    <section class="list">
      <div class="row header">
        <div class="center">Tag</div>
        <div>Item</div>
        <div class="center">Tier</div>
        <div>Base Stats <div class="center-info">(Health, Melee, Grenade, Super, Class, Weapons)</div></div>
        <div class="center">Total</div>
        <div class="center">Group</div>
        <div class="center">Rank</div>
        <div class="right" id="actionHeader">Copy ID</div>
      </div>
      <div id="rows"></div>
      <div id="empty" class="empty" style="display:none"><p>
        No items yet — upload a DIM CSV or click Restore last.<br/><br/>

        To export from DIM: <br/>
        ♦ Go to https://app.destinyitemmanager.com/ and sign in. <br/>
        ♦ Navigate to Organizer. <br/>
        ♦ Select any class. <br/>
        ♦ Click the "Armor.csv" button at the top right to download your armor data. <br/>
        ♦ Upload the downloaded CSV file here. <br/>
      </p></div>
    </section>
  </div>

  
<script type="module">
  import { StateStore, setRows, restoreRows, clearRows } from './beta-docs/state.js';
  import { initUI } from './beta-docs/ui-render.js';
  import { parseCsvFile } from './beta-docs/csv-adapter.js';
  import { adaptCsvRows, adaptBungieItems } from './beta-docs/items-adapter.js';
  import { BungieAuth } from './beta-docs/auth-bungie.js';
  import { loadCurrentProfile } from './beta-docs/bungie-client.js';
  import { loadManifest } from './beta-docs/manifest.js';
  import { DimSync } from './beta-docs/dim-sync.js';
  import { mergeDimTag } from './beta-docs/utils.js';
  import { BUNGIE_CLIENT_ID } from './beta-docs/config.js';

  const store = new StateStore();
  const auth = new BungieAuth(store);
  const dimSync = new DimSync(store);
  const appMount = document.getElementById('app');
  const signInButton = document.getElementById('signInWithBungie');

  const ui = initUI(store, {
    onCsvSelected: handleCsvSelected,
    onRestore: handleRestore,
    onClear: handleClear,
    onSignIn: () => auth.startLogin(),
    onPullSuccess: () => bootstrapBungieProfile(),
  });

  let manifestPromise = null;
  let lastDimMap = null;
  let profilePromise = null;

  store.subscribe((state) => {
    renderAppStatus(state);
    if (state.dim?.tagsByInstance && state.dim.tagsByInstance !== lastDimMap) {
      lastDimMap = state.dim.tagsByInstance;
      applyDimTags();
    }
  });

  try {
    await auth.handleRedirect();
  } catch (error) {
    console.error('OAuth redirect handling failed', error);
  }

  if (!BUNGIE_CLIENT_ID && signInButton) {
    signInButton.disabled = true;
    signInButton.classList.add('is-disabled');
    if (appMount) {
      appMount.textContent = 'Configure Bungie OAuth in window.D2AA_CONFIG to enable sign-in.';
    }
  }

  const cachedRows = restoreRows();
  if (cachedRows?.length) {
    setRows(store, cachedRows, 'csv');
    ui.resetUploadHint();
  }

  if (auth.tokens && BUNGIE_CLIENT_ID) {
    bootstrapBungieProfile();
  }

  async function ensureManifest() {
    if (!manifestPromise) {
      manifestPromise = loadManifest(store);
    }
    return manifestPromise;
  }

  async function bootstrapBungieProfile() {
    if (profilePromise) return profilePromise;
    profilePromise = (async () => {
      try {
        await ensureManifest();
        await loadCurrentProfile(auth, store);
        await dimSync.init(auth);
        applyDimTags();
        const state = store.getState();
        const adapted = adaptBungieItems(state.bungie.rawItems, state.manifest, state.dim.tagsByInstance);
        setRows(store, adapted, 'bungie');
        ui.setUploadHint('Loaded • Bungie profile');
      } catch (error) {
        console.error('Failed to load Bungie profile', error);
        if (appMount) {
          appMount.textContent = `Bungie profile failed: ${error.message}`;
        }
      }
    })().finally(() => {
      profilePromise = null;
    });
    return profilePromise;
  }

  async function handleCsvSelected(file) {
    try {
      const rows = await parseCsvFile(file);
      const state = store.getState();
      const adapted = adaptCsvRows(rows, state.dim.tagsByInstance);
      setRows(store, adapted, 'csv');
      ui.setUploadHint(`Loaded • ${file.name}`);
    } catch (error) {
      console.error('CSV parsing failed', error);
      alert(`Failed to parse CSV: ${error.message}`);
    } finally {
      ui.clearFileInput();
    }
  }

  function handleRestore() {
    const rows = restoreRows();
    if (rows && rows.length) {
      setRows(store, rows, 'csv');
      ui.resetUploadHint();
    } else {
      alert('No saved CSV found in this browser. Upload a DIM CSV first.');
    }
  }

  function handleClear() {
    setRows(store, [], store.getState().source);
    clearRows();
    ui.clearFileInput();
    ui.resetUploadHint();
  }

  function applyDimTags() {
    const state = store.getState();
    const map = state.dim?.tagsByInstance;
    if (!map) return;
    const rowsWithTags = state.rows.map((row) => mergeDimTag(row, map));
    setRows(store, rowsWithTags, state.source);
  }

  function renderAppStatus(state) {
    if (!appMount) return;
    const parts = [];
    if (state.bungie?.membershipId) {
      parts.push(`Signed in: ${state.bungie.membershipId}`);
    }
    if (state.source === 'bungie') {
      parts.push('Data source: Bungie profile');
    } else if (state.rows.length) {
      parts.push('Data source: CSV');
    }
    if (state.dim?.status === 'ready' && state.dim?.tagsByInstance?.size) {
      parts.push(`DIM tags: ${state.dim.tagsByInstance.size}`);
    }
    appMount.textContent = parts.join(' • ');
  }

  window.addEventListener('focus', () => {
    if (auth.tokens && BUNGIE_CLIENT_ID) {
      bootstrapBungieProfile();
    }
  });
</script>

</body>
</html>
